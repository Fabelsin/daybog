11. Написати правила YARA для виявлення обфускованих файлів бібліотек,
консольних виконуваних файлів, файлів картинок та відео в форматах
jpg, svg, mkv в середовищі ОС Linux.

Етап 1: Підготовка середовища
Оскільки ми працюємо на "чистому" Debian, спочатку потрібно встановити інструмент.
1. Встановлення YARA
Виконується від імені суперкористувача (root).
su -
apt update
apt install yara -y
• apt update — оновлює списки пакетів, щоб система знала про останні версії програм.
• apt install yara — встановлює сам пакет аналізатора.
• -y — автоматично відповідає "Yes" на запитання "Чи бажаєте ви продовжити?",
економлячи час.
 Етап 2: Створення правил YARA
Ми створили файл правил, який ігнорує розширення файлу (назву) і дивиться на його бінарну
структуру (байти).
Створення файлу
cat <<EOF > /root/detect_files.yar
import "math"
import "elf"
/* ПРАВИЛО 1: Linux ELF (Програми та бібліотеки) */
rule Linux_ELF_File {
 meta:
 description = "Detects Linux ELF executables"
 strings:
 // Магічні байти ELF: 0x7F 'E' 'L' 'F'. Це "паспорт" будь-якої програми Linux.
 \$elf_header = { 7F 45 4C 46 }
 // Сигнатура упаковувальника UPX (часто ховає віруси)
 \$upx_sig = "UPX!"
 condition:
 // Файл є програмою, якщо має заголовок ELF *АБО* містить слід UPX
 \$elf_header at 0 or \$upx_sig
}
/* ПРАВИЛО 2: Обфусковані/Зашифровані ELF */
rule Obfuscated_Packed_ELF {
 meta:
 description = "Detects packed ELF (High Entropy)"
 strings:
 \$elf_header = { 7F 45 4C 46 }
 condition:
 // Якщо це ELF і його ентропія (хаос) вище 7.5 - він точно стиснений або шифрований.
 \$elf_header at 0 and math.entropy(0, filesize) >= 7.5
}
/* ПРАВИЛО 3: Зображення JPG */
rule Image_JPG {
 meta:
 description = "Detects JPEG"
 strings:
 // FF D8 FF - стандартний початок будь-якого JPG файлу.
 \$jpg_header = { FF D8 FF }
 condition:
 // Перевіряємо тільки на початку файлу (offset 0)
 \$jpg_header at 0
}
/* ПРАВИЛО 4: Відео MKV */
rule Video_MKV {
 meta:
 description = "Detects MKV video"
 strings:
 // Унікальний підпис контейнера Matroska
 \$mkv_header = { 1A 45 DF A3 }
 \$doc_type = "matroska"
 condition:
 \$mkv_header at 0 or \$doc_type
}
EOF
Пояснення ключових елементів:
• strings: Тут ми визначаємо, що саме шукаємо (шістнадцяткові коди { 7F... } або текст
"UPX!").
• condition: Логіка правила.
o at 0: Шукати суворо на початку файлу (перший байт).
o or: Логічне "АБО" (спрацює, якщо знайдено хоча б одну ознаку).
o math.entropy: Функція для вимірювання випадковості даних (від 0 до 8).
Звичайний текст має низьку ентропію (~4), а шифровані віруси — високу (~7.9).
 Етап 3: Підготовка тестового полігону ("Обфускація")
Ми створили спеціальну папку і наповнили її файлами-обманками, щоб перевірити пильність
системи.
# 1. Створюємо робочу папку
mkdir /tmp/yara_test
cd /tmp/yara_test
# 2. Обманка №1: Виконуваний файл під виглядом картинки
# Копіюємо системну утиліту 'ls' і називаємо її .jpg
cp /bin/ls ./fake_image.jpg
# 3. Обманка №2: Текстовий файл, що прикидається картинкою JPG
# Записуємо "магічні байти" JPG (FF D8 FF) у файл
echo -ne "\xFF\xD8\xFF\xE0" > real_signature.bin
# -n: не додавати перенос рядка в кінці
# -e: дозволити запис спецсимволів (\x..)
# 4. Обманка №3: Текст під виглядом Відео
# Записуємо заголовок MKV у файл
echo -ne "\x1A\x45\xDF\xA3" > hidden_video.txt
 Етап 4: Запуск сканування та Аналіз результатів
Це момент істини. Ми запускаємо YARA, вказуючи їй файл правил і папку для перевірки.
# Синтаксис: yara [файл_правил] [папка_для_сканування]
yara /root/detect_files.yar /tmp/yara_test
Отримані результати (з поясненням):
1. Linux_ELF_File /tmp/yara_test/fake_image.jpg
o Що це значить: Система проігнорувала розширення .jpg. Вона побачила
всередині байти 7F 45 4C 46 і зрозуміла: "Це не картинка, це програма для
Linux!".
o Чому це важливо: Хакери часто маскують віруси під фото котиків. Це правило
їх викриває.
2. Image_JPG /tmp/yara_test/real_signature.bin
o Що це значить: Хоча файл має дивне розширення .bin, YARA побачила
заголовок JPEG і ідентифікувала його як картинку.
3. Video_MKV /tmp/yara_test/hidden_video.txt
o Що це значить: Файл називається .txt (текст), але починається з байтів відеоформату Matroska.
